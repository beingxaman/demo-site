<!DOCTYPE html>
<html>
<head>
  <title>CSPT ‚Üí IDOR (Hardened)</title>
  <style>
    body { font-family: Arial; }
    button { margin: 5px; }
    #content { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    .admin { color: red; }
  </style>
</head>
<body>

<h2>User Dashboard (Hardened Routing)</h2>

<button onclick="navigate('profile')">My Profile</button>
<button onclick="navigate('settings')">Settings</button>

<div id="content">Loading‚Ä¶</div>

<script>
/* =======================
   USER DATABASE (IDOR)
======================= */
const USER_DATA = {
  "1001": { name: "Aman", role: "user", email: "aman@site.com" },
  "9999": { name: "Admin", role: "admin", email: "admin@site.com" }
};

/* =======================
   FILE SYSTEM
   ‚ö†Ô∏è NOTICE:
   - NO /pages/admin.html
   - Admin exists ONLY internally
======================= */
const FILE_SYSTEM = {
  "/pages/profile.html": `
    <h3>My Profile</h3>
    <button onclick="loadUser('1001')">View My Data</button>
  `,

  "/pages/settings.html": `
    <h3>Settings</h3>
    <p>Safe content</p>
  `,

  "/internal/admin.html": `
    <h3 class="admin">INTERNAL ADMIN PANEL</h3>
    <button onclick="loadUser('9999')">Load Admin Account</button>
  `
};

/* =======================
   HARDENED ROUTING (BUGGY)
======================= */

// Developer thinks this is secure üëá
const ALLOWED_TABS = ["profile", "settings"];

function resolvePath(base, input) {
  const full = base + input + ".html";
  const stack = [];

  full.split("/").forEach(p => {
    if (p === "..") stack.pop();
    else if (p && p !== ".") stack.push(p);
  });

  return "/" + stack.join("/");
}

function navigate(tab) {
  history.pushState({}, "", "?tab=" + tab);
  load(tab);
}

function load(tab) {
  // ‚ùå Weak allowlist check
  if (!ALLOWED_TABS.includes(tab)) {
    console.warn("Blocked tab:", tab);
  }

  const path = resolvePath("/pages/", tab);
  console.log("Resolved path:", path);

  document.getElementById("content").innerHTML =
    FILE_SYSTEM[path] || "<p style='color:red'>404 - Not Found</p>";
}

/* =======================
   IDOR (NO AUTH CHECK)
======================= */
function loadUser(userId) {
  const user = USER_DATA[userId];

  document.getElementById("content").innerHTML = `
    <h3>User Data</h3>
    <p><b>ID:</b> ${userId}</p>
    <p><b>Name:</b> ${user.name}</p>
    <p><b>Role:</b> ${user.role}</p>
    <p><b>Email:</b> ${user.email}</p>
  `;
}

/* Initial load */
const t = new URLSearchParams(location.search).get("tab");
if (t) load(t);
</script>

</body>
</html>
